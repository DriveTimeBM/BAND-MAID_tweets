<script>
  let tweets = [];
  let miniSearch;
  let renderedCount = 0;
  const batchSize = 200;
  let currentList = [];

  async function loadTweets() {
    const res = await fetch("tweets.json");
    tweets = await res.json();

    // Chronological by GMT
    tweets.sort((a, b) => new Date(a.dateJST) - new Date(b.dateJST));

    miniSearch = new MiniSearch({
      fields: ['jp', 'en', 'member'], 
      storeFields: ['id', 'dateJST', 'member', 'jp', 'en', 'url']
    });

    miniSearch.addAll(tweets);
    currentList = tweets;
    renderNextBatch();
  }

  function renderNextBatch() {
    const container = document.getElementById('results');
    const slice = currentList.slice(renderedCount, renderedCount + batchSize);

    for (const t of slice) {
      const div = document.createElement("div");
      div.className = "tweet";
      div.innerHTML = `
        <div class="meta">
          <b>${t.member}</b> | <a href="${t.url}" target="_blank">${t.dateJST}</a>
        </div>
        <div class="jp">${t.jp}</div>
        <div class="en">${t.en}</div>
      `;
      container.appendChild(div);
    }

    renderedCount += slice.length;
    toggleLoadMore();
  }

  function resetRender(list) {
    document.getElementById('results').innerHTML = "";
    renderedCount = 0;
    currentList = list;
    renderNextBatch();
  }

  function toggleLoadMore() {
    const btn = document.getElementById('loadMore');
    btn.style.display = (renderedCount < currentList.length) ? "block" : "none";
  }

  document.getElementById('search').addEventListener('input', e => {
    const query = e.target.value.trim();
    if (!query) {
      resetRender(tweets);
    } else {
      const results = miniSearch.search(query);
      resetRender(results.map(r => r));
    }
  });

  document.getElementById('loadMore').addEventListener('click', renderNextBatch);

  loadTweets();
</script>
