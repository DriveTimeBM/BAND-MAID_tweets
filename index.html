<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>BAND-MAID Tweets Archive</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #search { width: 300px; padding: 5px; }
    .tweet { border-bottom: 1px solid #ccc; padding: 10px 0; }
    .tweet-time { font-weight: bold; }
    .member { color: #555; }
    .jp { margin-top: 5px; }
    .en { margin-top: 5px; color: #333; }
    #loadMore { margin: 20px 0; padding: 10px 20px; cursor: pointer; }
    #toggleSort { margin-left: 10px; padding: 5px 10px; cursor: pointer; }
  </style>
</head>
<body>
  <h1>BAND-MAID Tweets Archive</h1>
  <input type="text" id="search" placeholder="Search tweets...">
  <button id="toggleSort">Sort: Old → New</button>
  <div id="tweets"></div>
  <button id="loadMore">Load More</button>

  <script src="https://unpkg.com/minisearch/dist/umd/index.min.js"></script>
  <script>
    let tweets = [];
    let minisearch;
    let results = [];
    let displayIndex = 0;
    const BATCH_SIZE = 50;
    let sortAsc = true; // default: old → new

    async function loadData() {
      const response = await fetch('tweets.json');
      tweets = await response.json();

      minisearch = new MiniSearch({
        fields: ['jp', 'en', 'member'],
        storeFields: ['id', 'dateJST', 'member', 'jp', 'en', 'url']
      });

      minisearch.addAll(tweets);

      sortTweets();
      results = tweets;
      renderBatch();
    }

    function sortTweets() {
      results.sort((a, b) => {
        const da = new Date(a.dateJST.replace(' ', 'T'));
        const db = new Date(b.dateJST.replace(' ', 'T'));
        return sortAsc ? da - db : db - da;
      });
    }

    function renderBatch() {
      const container = document.getElementById('tweets');
      const slice = results.slice(displayIndex, displayIndex + BATCH_SIZE);

      slice.forEach(tweet => {
        const div = document.createElement('div');
        div.className = 'tweet';
        div.innerHTML = `
          <div class="tweet-time"><a href="${tweet.url}" target="_blank">${tweet.dateJST}</a></div>
          <div class="member">${tweet.member}</div>
          <div class="jp">${tweet.jp}</div>
          <div class="en">${tweet.en}</div>
        `;
        container.appendChild(div);
      });

      displayIndex += slice.length;

      if (displayIndex >= results.length) {
        document.getElementById('loadMore').style.display = 'none';
      } else {
        document.getElementById('loadMore').style.display = 'block';
      }
    }

    function resetAndRender(newResults) {
      results = newResults;
      sortTweets();
      displayIndex = 0;
      document.getElementById('tweets').innerHTML = '';
      renderBatch();
    }

    document.getElementById('search').addEventListener('input', e => {
      const query = e.target.value.trim();
      if (query === '') {
        resetAndRender(tweets);
      } else {
        const searchResults = minisearch.search(query, { prefix: true });
        resetAndRender(searchResults.map(r => r));
      }
    });

    document.getElementById('loadMore').addEventListener('click', renderBatch);

    document.getElementById('toggleSort').addEventListener('click', () => {
      sortAsc = !sortAsc;
      document.getElementById('toggleSort').innerText = sortAsc ? 'Sort: Old → New' : 'Sort: New → Old';
      resetAndRender(results);
    });

    loadData();
  </script>
</body>
</html>
